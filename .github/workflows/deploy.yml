name: Deploy via Self-Hosted Runner

on:
  push:
    branches: [main, dev]

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: main
            deploy_path: /home/reyhanjs/public_html
            port: "4003"
            start_script: start
            runs_on: '["self-hosted","linux","x64","reyhanjs"]'
          - branch: dev
            deploy_path: /home/devreyhanjs/public_html
            port: "4002"
            start_script: startdev
            runs_on: '["self-hosted","linux","x64","devreyhanjs"]'

    if: github.ref_name == matrix.branch
    runs-on: ${{ fromJSON(matrix.runs_on) }}

    env:
      DEPLOY_PATH: ${{ matrix.deploy_path }}
      PORT: ${{ matrix.port }}
      START_SCRIPT: ${{ matrix.start_script }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Stop old app (pid + port fallback)
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH" 2>/dev/null || true

          if [ -f logs/app.pid ]; then
            kill "$(cat logs/app.pid)" 2>/dev/null || true
            rm -f logs/app.pid || true
          fi

          fuser -k "${PORT}/tcp" 2>/dev/null || true

      - name: Sync project to deployment folder (keeps logs/)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$DEPLOY_PATH"

          rsync -av --delete \
            --filter=':- .gitignore' \
            --exclude='logs/' \
            ./ "$DEPLOY_PATH/"

      - name: Install, build, prune
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"
          npm ci
          rm -rf .next || true
          npm run build
          npm prune --omit=dev

      - name: Start (nohup + pid)
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"
          mkdir -p logs

          nohup npm run "$START_SCRIPT" > logs/app.log 2>&1 &
          echo $! > logs/app.pid

          ss -lntp | grep ":${PORT}" || true
          tail -n 30 logs/app.log || true
