name: Deploy via Self-Hosted Runner

on:
  push:
    branches: [main, dev]

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Setup parameters (branch -> path/port/start)
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF_NAME}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          if [ "$BRANCH" = "main" ]; then
            echo "DEPLOY_PATH=/home/reyhanjs/public_html" >> "$GITHUB_ENV"
            echo "PORT=4003" >> "$GITHUB_ENV"
            echo "START_SCRIPT=start" >> "$GITHUB_ENV"
          elif [ "$BRANCH" = "dev" ]; then
            echo "DEPLOY_PATH=/home/devreyhanjs/public_html" >> "$GITHUB_ENV"
            echo "PORT=4002" >> "$GITHUB_ENV"
            echo "START_SCRIPT=startdev" >> "$GITHUB_ENV"
          else
            echo "Unsupported branch: $BRANCH"
            exit 0
          fi

          echo "REPO_URL=https://github.com/reyhan-affandie/reyhanjs.git" >> "$GITHUB_ENV"

      - name: Allow git in deploy folder (safe.directory)
        shell: bash
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$DEPLOY_PATH" || true

      - name: Ensure repo exists in deploy folder
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          if [ ! -d ".git" ]; then
            git clone --branch "$BRANCH" --single-branch "$REPO_URL" .
          fi

          git remote set-url origin "$REPO_URL"

      - name: Pull latest (dev/main)
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"

          git fetch origin "$BRANCH"
          git checkout -f "$BRANCH" || git switch -f "$BRANCH"
          git reset --hard "origin/$BRANCH"

      - name: Clean tracked files (keep logs + env)
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"

          git clean -fdx -e logs/ -e .env -e .env.* || true

      - name: Stop old app (pid + port fallback)
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH" || true

          mkdir -p logs

          if [ -f logs/app.pid ]; then
            kill "$(cat logs/app.pid)" 2>/dev/null || true
            rm -f logs/app.pid || true
          fi

          fuser -k "${PORT}/tcp" 2>/dev/null || true

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"
          npm ci

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"
          rm -rf .next || true
          npm run build

      - name: Prune dev dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"
          npm prune --omit=dev

      - name: Start app (nohup + pid)
        shell: bash
        run: |
          set -euo pipefail
          cd "$DEPLOY_PATH"
          mkdir -p logs

          nohup npm run "$START_SCRIPT" > logs/app.log 2>&1 &
          echo $! > logs/app.pid

      - name: Health check (port + last logs)
        shell: bash
        run: |
          set -euo pipefail
          ss -lntp | grep ":${PORT}" || true
          tail -n 40 "$DEPLOY_PATH/logs/app.log" || true
