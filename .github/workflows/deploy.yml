name: Deploy via Self-Hosted Runner

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set deployment config (dev/prod)
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF_NAME}"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

          if [ "$BRANCH" = "main" ]; then
            echo "DEPLOY_USER=reyhanjs" >> "$GITHUB_ENV"
            echo "DEPLOY_PATH=/home/reyhanjs/public_html" >> "$GITHUB_ENV"
            echo "START_SCRIPT=start" >> "$GITHUB_ENV"   # npm run start -> 4003
            echo "PORT=4003" >> "$GITHUB_ENV"
          elif [ "$BRANCH" = "dev" ]; then
            echo "DEPLOY_USER=devreyhanjs" >> "$GITHUB_ENV"
            echo "DEPLOY_PATH=/home/devreyhanjs/public_html" >> "$GITHUB_ENV"
            echo "START_SCRIPT=startdev" >> "$GITHUB_ENV" # npm run startdev -> 4002
            echo "PORT=4002" >> "$GITHUB_ENV"
          else
            echo "Unsupported branch: $BRANCH"
            exit 0
          fi

      - name: Sync project to deployment folder (as deploy user, uses .gitignore)
        shell: bash
        run: |
          set -euo pipefail
          sudo -u "$DEPLOY_USER" rsync -av --delete --filter=':- .gitignore' ./ "$DEPLOY_PATH/"

      - name: Install dependencies (includes dev deps for build)
        shell: bash
        run: |
          set -euo pipefail
          sudo -u "$DEPLOY_USER" bash -lc "cd '$DEPLOY_PATH' && npm ci"

      - name: Clean Next cache
        shell: bash
        run: |
          set -euo pipefail
          sudo -u "$DEPLOY_USER" bash -lc "cd '$DEPLOY_PATH' && rm -rf .next || true"

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          sudo -u "$DEPLOY_USER" bash -lc "cd '$DEPLOY_PATH' && npm run build"

      - name: Prune dev dependencies (after build)
        shell: bash
        run: |
          set -euo pipefail
          sudo -u "$DEPLOY_USER" bash -lc "cd '$DEPLOY_PATH' && npm prune --omit=dev"

      - name: Restart app (nohup + pid)
        shell: bash
        run: |
          set -euo pipefail

          sudo -u "$DEPLOY_USER" bash -lc "
            cd '$DEPLOY_PATH'
            mkdir -p logs

            if [ -f logs/app.pid ]; then
              kill \$(cat logs/app.pid) 2>/dev/null || true
              rm -f logs/app.pid
            fi

            nohup npm run ${START_SCRIPT} > logs/app.log 2>&1 &
            echo \$! > logs/app.pid
          "
